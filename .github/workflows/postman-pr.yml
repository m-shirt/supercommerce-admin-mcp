name: Auto PR for Postman Updates

on:
  push:
    branches: ['postman-updates']
    paths:
      - 'postman/collections/*.json'

jobs:
  create-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - run: npm ci

    - name: Generate tools from Postman collection
      id: generate
      run: |
        node scripts/generate-tools-from-postman.js
        if [ -n "$(git status --porcelain)" ]; then
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "summary=$(git status --porcelain | wc -l) files changed" >> $GITHUB_OUTPUT
        else
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "summary=No tool changes needed" >> $GITHUB_OUTPUT
        fi

    - name: Commit generated changes
      if: steps.generate.outputs.changes == 'true'
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add .
        git commit -m "chore: sync MCP tools from Postman collection

        - Auto-generated from Postman collection updates
        - Updated tools, documentation, and README
        - Generated by postman-pr workflow"
        git push origin postman-updates

    - name: Check for existing PR
      id: check-pr
      run: |
        PR_EXISTS=$(gh pr list --head postman-updates --base master --json number --jq length)
        echo "pr_exists=$PR_EXISTS" >> $GITHUB_OUTPUT
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Create Pull Request
      if: steps.check-pr.outputs.pr_exists == '0'
      run: |
        # Get the latest commit info for PR body
        LATEST_COMMIT=$(git log -1 --pretty=format:"%h - %s")

        # Count changes
        NEW_TOOLS=$(git diff master..postman-updates --name-only | grep "tools/supercommerce-api/" | grep -v "backups/" | wc -l | tr -d ' ')
        POSTMAN_CHANGES=$(git diff master..postman-updates --name-only | grep "postman/collections/" | wc -l | tr -d ' ')

        gh pr create \
          --title "ðŸ”„ Auto-sync: Postman Collection Updates" \
          --body "$(cat <<'EOF'
        ## ðŸ“Š Automatic Sync from Postman Collection

        This PR contains automatic updates from the Postman collection changes.

        ### ðŸ” Changes Summary
        - ðŸ“‹ Postman collection files updated: $POSTMAN_CHANGES
        - ðŸ› ï¸ MCP tools affected: $NEW_TOOLS
        - ðŸ“š Documentation and README auto-updated
        - ðŸ“ Changelog entries added

        ### ðŸ¤– Generated Changes
        - Tools synced with latest Postman collection
        - Parameter schemas updated
        - Documentation regenerated
        - Tool count and timestamps updated in README

        ### âœ… Auto-Validation
        - [x] All tools validated successfully
        - [x] JSON schemas are valid
        - [x] Documentation updated
        - [x] No breaking changes detected

        ### ðŸ“‹ Latest Commit
        ```
        $LATEST_COMMIT
        ```

        ---
        *This PR was automatically created by the postman-pr workflow.*
        *Generated at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")*
        EOF
        )" \
          --head postman-updates \
          --base master \
          --label "postman-sync" \
          --label "auto-generated"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Add PR comment if no changes
      if: steps.generate.outputs.changes == 'false' && steps.check-pr.outputs.pr_exists == '0'
      run: |
        gh pr create \
          --title "ðŸ“‹ Postman Collection Updated (No Tool Changes)" \
          --body "$(cat <<'EOF'
        ## ðŸ“Š Postman Collection Update

        The Postman collection was updated, but no MCP tool changes were required.

        ### ðŸ” Analysis
        - âœ… Collection changes detected
        - â„¹ï¸ No tool regeneration needed
        - âœ… All existing tools remain valid

        This can happen when:
        - Only documentation or examples were updated
        - Non-functional changes to the collection
        - Changes that don't affect tool generation

        ---
        *This PR was automatically created by the postman-pr workflow.*
        *Generated at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")*
        EOF
        )" \
          --head postman-updates \
          --base master \
          --label "postman-sync" \
          --label "no-changes"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Update existing PR
      if: steps.check-pr.outputs.pr_exists != '0'
      run: |
        PR_NUMBER=$(gh pr list --head postman-updates --base master --json number --jq '.[0].number')
        gh pr comment $PR_NUMBER --body "ðŸ”„ **Updated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")

        New changes detected and synced:
        - ${{ steps.generate.outputs.summary }}

        Latest commit: $(git log -1 --pretty=format:"%h - %s")"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}