name: Claude Auto-Fix Issues

on:
  issues:
    types: [opened, labeled]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  analyze-and-fix:
    runs-on: ubuntu-latest
    # Only run if issue has 'auto-fix' label or contains specific keywords
    if: |
      contains(github.event.issue.labels.*.name, 'auto-fix') ||
      contains(github.event.issue.title, '[auto-fix]') ||
      contains(github.event.issue.title, '[fix-me]')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Claude SDK
        run: |
          pip install anthropic
          pip install GitPython PyGithub

      - name: Create fix branch
        id: branch
        run: |
          BRANCH_NAME="auto-fix/issue-${{ github.event.issue.number }}"
          git config --global user.name "Claude Bot"
          git config --global user.email "claude-bot@github.com"
          git checkout -b $BRANCH_NAME
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Analyze issue with Claude
        id: analyze
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          python .github/scripts/claude_fix_issue.py

      - name: Run tests
        id: test
        continue-on-error: true
        run: |
          npm test 2>&1 | tee test-output.log
          echo "test_status=$?" >> $GITHUB_OUTPUT

      - name: Run linting
        id: lint
        continue-on-error: true
        run: |
          npm run lint 2>&1 | tee lint-output.log
          echo "lint_status=$?" >> $GITHUB_OUTPUT

      - name: Commit changes
        id: commit
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git add -A
            git commit -m "fix: auto-fix for issue #${{ github.event.issue.number }}

            Automated fix generated by Claude AI for issue:
            ${{ github.event.issue.title }}

            Closes #${{ github.event.issue.number }}"
            echo "changes_made=true" >> $GITHUB_OUTPUT
          else
            echo "changes_made=false" >> $GITHUB_OUTPUT
          fi

      - name: Push changes
        if: steps.commit.outputs.changes_made == 'true'
        run: |
          git push origin ${{ steps.branch.outputs.branch_name }}

      - name: Create Pull Request
        if: steps.commit.outputs.changes_made == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --title "🤖 Auto-fix: ${{ github.event.issue.title }}" \
            --body "## 🤖 Automated Fix

            This PR was automatically generated by Claude AI to fix issue #${{ github.event.issue.number }}

            ### 📋 Issue Summary
            **Title:** ${{ github.event.issue.title }}
            **Issue:** #${{ github.event.issue.number }}

            ### ✅ Checks
            - Test Status: ${{ steps.test.outputs.test_status == '0' && '✅ Passing' || '⚠️ Failed' }}
            - Lint Status: ${{ steps.lint.outputs.lint_status == '0' && '✅ Passing' || '⚠️ Failed' }}

            ### 🔍 Review Needed
            Please review the changes carefully before merging. This is an AI-generated fix.

            ### 📝 Notes
            - Generated using Claude 3.5 Sonnet
            - Automated workflow triggered by issue creation
            - Human review is strongly recommended

            Closes #${{ github.event.issue.number }}" \
            --head ${{ steps.branch.outputs.branch_name }} \
            --base main \
            --label "auto-generated" \
            --label "needs-review"

      - name: Comment on issue
        if: steps.commit.outputs.changes_made == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} \
            --body "🤖 **Claude Auto-Fix Bot**

            I've analyzed this issue and created a pull request with a potential fix!

            🔗 Pull Request: Check the PR linked above

            Please review the changes carefully as this is an AI-generated solution."

      - name: Comment if no fix needed
        if: steps.commit.outputs.changes_made == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} \
            --body "🤖 **Claude Auto-Fix Bot**

            I've analyzed this issue but couldn't generate an automatic fix. This might require manual intervention.

            The issue may be:
            - Too complex for automated fixing
            - Requiring design decisions
            - Missing context or information

            A human developer should review this issue."