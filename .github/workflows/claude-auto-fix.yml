name: Claude Auto-Fix Issues

on:
  issues:
    types: [opened, labeled]

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

jobs:
  analyze-and-fix:
    runs-on: ubuntu-latest
    # Only run if issue has 'auto-fix' label or contains specific keywords
    if: |
      contains(github.event.issue.labels.*.name, 'auto-fix') ||
      contains(github.event.issue.title, '[auto-fix]') ||
      contains(github.event.issue.title, '[fix-me]')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Create fix branch
        id: branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH_NAME="auto-fix/issue-${{ github.event.issue.number }}"
          git config --global user.name "Claude Bot"
          git config --global user.email "claude-bot@github.com"
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git
          git checkout -b $BRANCH_NAME
          git push -u origin $BRANCH_NAME
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Analyze and fix issue with Claude
        id: claude-fix
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            You need to analyze and fix the following GitHub issue:

            Issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}

            Issue Description:
            ${{ github.event.issue.body }}

            Please:
            1. Analyze the issue and understand what's wrong
            2. Search the codebase to find the relevant files
            3. Fix the issue by modifying the necessary files
            4. After making changes, commit them with a descriptive message
            5. Run tests if available to verify the fix

            The fix should be committed to the current branch: ${{ steps.branch.outputs.branch_name }}

            Use the repository's CLAUDE.md for guidance on style and conventions.
            Make sure to actually fix the issue, not just analyze it.

          claude_args: '--allowed-tools "Bash,Read,Write,Edit,Glob,Grep,TodoWrite"'

      - name: Check if changes were made
        id: check-changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git
          if [ -n "$(git status --porcelain)" ]; then
            echo "changes_made=true" >> $GITHUB_OUTPUT
            git add -A
            git commit -m "fix: auto-fix for issue #${{ github.event.issue.number }}

            Automated fix generated by Claude AI
            Closes #${{ github.event.issue.number }}" || true
            git push origin ${{ steps.branch.outputs.branch_name }}
          elif [ -n "$(git log origin/master..HEAD)" ]; then
            echo "changes_made=true" >> $GITHUB_OUTPUT
            git push origin ${{ steps.branch.outputs.branch_name }}
          else
            echo "changes_made=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.check-changes.outputs.changes_made == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --title "🤖 Auto-fix: ${{ github.event.issue.title }}" \
            --body "## 🤖 Automated Fix

            This PR was automatically generated by Claude AI to fix issue #${{ github.event.issue.number }}

            ### 📋 Issue Summary
            **Title:** ${{ github.event.issue.title }}
            **Issue:** #${{ github.event.issue.number }}

            ### 🔍 Review Needed
            Please review the changes carefully before merging. This is an AI-generated fix.

            ### 📝 Notes
            - Generated using Claude Code GitHub Action
            - Automated workflow triggered by issue creation
            - Human review is strongly recommended

            Closes #${{ github.event.issue.number }}" \
            --head ${{ steps.branch.outputs.branch_name }} \
            --base master \
            --label "auto-generated" \
            --label "needs-review" || true

      - name: Comment on issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ steps.check-changes.outputs.changes_made }}" == "true" ]; then
            gh issue comment ${{ github.event.issue.number }} \
              --body "🤖 **Claude Auto-Fix Bot**

              I've analyzed this issue and created a pull request with a potential fix!

              🔗 Pull Request: Check the PR linked above

              Please review the changes carefully as this is an AI-generated solution."
          else
            gh issue comment ${{ github.event.issue.number }} \
              --body "🤖 **Claude Auto-Fix Bot**

              I've analyzed this issue but couldn't generate an automatic fix. This might require manual intervention.

              The issue may be:
              - Too complex for automated fixing
              - Requiring design decisions
              - Missing context or information

              A human developer should review this issue."
          fi